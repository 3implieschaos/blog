<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AWS Virtual Machines, cook thyself! Part I &mdash; doctimjones</title>
  <meta name="author" content="Tim Jones">






  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="http://doctimjones.org/favicon.png" rel="icon">

  <link href="http://doctimjones.org/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script></head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://doctimjones.org/">doctimjones</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<ul class="main-navigation">
      <li >
        <a href="http://doctimjones.org/category/computer-science.html">Computer science</a>
      </li>
      <li >
        <a href="http://doctimjones.org/category/data-science.html">Data science</a>
      </li>
      <li class="active">
        <a href="http://doctimjones.org/category/devops.html">Devops</a>
      </li>
      <li >
        <a href="http://doctimjones.org/category/math.html">Math</a>
      </li>
      <li >
        <a href="http://doctimjones.org/category/mathematics-systems.html">Mathematics, systems</a>
      </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">AWS Virtual Machines, cook thyself! Part I</h1>
    <p class="meta">
<time datetime="2017-01-28T17:00:00-05:00" pubdate>Sat 28 January 2017</time>    </p>
</header>

  <div class="entry-content"><h3>Motivation</h3>
<p>Cloudformation offers a nice solution to orchestrating infrastructure deployment, but has its limitations. Its built in method for deployment scripts, "User Data", is difficult to maintain and unwieldy for more complicated systems. This walkthrough tutorial shows you how you can use chef, AWS KMS, and AWS Cloudformation together to get the best of both worlds--full automation with Cloudformation coupled with Chef's configuration management. </p>
<p>In Part I, we create a chef cookbook to install the Cloud 9 IDE development package on a server.</p>
<p>In Part II, we do the same thing using Puppet.</p>
<p>In Part III, we demonstrate how to use Cloudformation to have boxes spin up in AWS and automatically cook themselves using either of these provisioning methods.</p>
<h5>(why not use Opsworks instead)?</h5>
<p>Opsworks is limiting in some ways that many, including myself, feel does not permit the full use of Chef. This solution cuts out Opsworks as the middle-man, so to speak, and leverages the full power of chef-solo automatically.</p>
<h2>Part I: Quick Chef Walkthrough</h2>
<h3>Yet another chef tutorial</h3>
<p>You can of course skip this step if you are familiar with Chef to a great enough degree, but in the spirit of making this a self-contained walkthrough, we will start from the ground up.</p>
<h4>Getting started</h4>
<h5>Installing ChefDK</h5>
<p>It is widely considered best practice to use <a href="https://downloads.chef.io/chefdk">ChefDK</a>, and this walkthrough uses ChefDK exclusively.</p>
<ul>
<li>On Mac, install <a href="http://brew.sh/">HomeBrew</a> and run <code>brew cask install chefdk</code></li>
<li>On Linux, <a href="https://downloads.chef.io/chefdk">download a package</a> corresponding to your distro and install accordingly.</li>
<li>On Windows: Run Linux as a Virtual Machine, get Docker for Windows, or <em>try</em> using Bash on Windows, but this walkthrough doesn't support Windows-based development. </li>
</ul>
<h5>Initiating your cookbook</h5>
<p>Let's start with the following command:</p>
<div class="highlight"><pre><span></span>chef generate cookbook c9_ide_chef
</pre></div>


<p>This command generates a template for a cookbook. Note that we use and underline in the name instead of a hyphen as hyphens can be problematic for chef in some circumstances. We now have a folder with the following content:</p>
<div class="highlight"><pre><span></span>├── .gitignore
├── .kitchen.yml
├── Berksfile
├── README.md
├── chefignore
├── metadata.rb
├── recipes
│   └── default.rb
├── spec
│   ├── spec_helper.rb
│   └── unit
│       └── recipes
│           └── default_spec.rb
└── test
    └── smoke
        └── default
            └── default_test.rb
</pre></div>


<p>It also  creates a <code>.delivery</code> and a <code>.git</code> folder whose contents are omitted here for clarity. </p>
<p>The second command creates an attribute folder which we can populate with default attributes for our cookbook, and the third line creates a default template for a "message of the day" to be displayed when first logging in. </p>
<p>The <code>.git</code> directory is useful and we will use it as the basis for a new repo in github repo. </p>
<h5>Pushing to GitHub</h5>
<p>Now that we have the skeleton for our cookbook, we should start pushing to GitHub for version-control. On GitHub, create a public repo called c9_ide. Then run the following commands:</p>
<div class="highlight"><pre><span></span>git add .
git commit -m &quot;First commit&quot;
git remote add origin git@github.com:YOUR_GITHUB_USERNAME/c9_ide_chef.git
git push -u origin master
</pre></div>


<p>Now the stage is set and we are ready to make the cookbook actually do something.</p>
<h4>Create the core configuration</h4>
<h5>Creating a story for the cookbook</h5>
<p>So far we've seen how to set up the cookbook, but we don't quite know what we are going to do with it. Now is a good time to set up some goals for our cookbook:</p>
<ul>
<li>It should update all packages before doing anything else</li>
<li>It should create a message of the day that gives basic information about the server to a user logging in</li>
<li>It should install basic security packages and other utilities</li>
<li>It should install the packages needed to run Cloud 9 IDE</li>
<li>It should pull and install Cloud 9 IDE</li>
</ul>
<h6>Updating all packages</h6>
<p>Just for fun, we are going to make our cookbook work for both Debian and RHEL variations of Linux. Under the recipes folder, let's create a recipe file called <code>update.rb</code> and give it contents:</p>
<div class="highlight"><pre><span></span># Update system to start with
case node[&#39;platform&#39;]


when &#39;debian&#39;, &#39;ubuntu&#39;

    execute &#39;AptUpdateUpgrade&#39; do
        command &quot;apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get upgrade -y&quot;
    end

when &#39;redhat&#39;, &#39;centos&#39;, &#39;fedora&#39;

     # Update all packages
    execute &#39;UpdateYum&#39; do
        command &quot;yum -y update&quot;
    end

    # Add Fedora&#39;s Extra Packages for Enterprise Linux
    execute &#39;GetEPELRepo&#39; do
        command &quot;rpm -iUvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-9.noarch.rpm&quot;
        not_if &quot;rpm -qa | grep -qx &#39;epel-release-7-9.noarch&#39;&quot;
    end

end
</pre></div>


<p>in the <code>default.rb</code> recipe, add the line:</p>
<div class="highlight"><pre><span></span>include_recipe &#39;c9_ide::update&#39;
</pre></div>


<p>That's it for now! Before we go any further, let's test this. Chef has automatically added some basis for testing to your repo. Let's start with kitchen. This assumes you have <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a> and <a href="https://www.vagrantup.com/">Vagrant</a> installed (if you don't, install them). At the base directory, run:</p>
<div class="highlight"><pre><span></span>kitchen create
kitchen converge
</pre></div>


<p>The first command creates the virtual machines for us to work with, and teh second command cooks Chef inside of them. It is a very convenient way to do a full test of your code before pushing to github. The converge command may take quite a while as we are updating all packages on the systems and doing it for two VMs, and Ubuntu one and a CentOS one. If all goes well, the final output looks like:</p>
<div class="highlight"><pre><span></span>Chef Client finished, 1/1 resources updated in 02 minutes 21 seconds
</pre></div>


<h6>Creating a C9 User</h6>
<p>It is rarely a good idea to run a program as root. As such, our next step is to create a user for running the Cloud 9 IDE. We start by creating a data bag. First, install knife-solo and <a href="https://github.com/thbishop/knife-solo_data_bag">knife-solo data bag</a>:</p>
<div class="highlight"><pre><span></span>chef gem install knife-solo
chef gem install knife-solo_data_bag
</pre></div>


<p>This is not entirely necessary, but that tool can be useful in other ways for making chef solo cookbooks. Then we can generate a databag and databag item:</p>
<div class="highlight"><pre><span></span>mkdir data_bags
export EDITOR=&quot;vi&quot;
knife solo data bag create users c9ide
</pre></div>


<p>In the editor that pops up, paste the following content:</p>
<div class="highlight"><pre><span></span>{
  &quot;id&quot;: &quot;c9ide&quot;,
  &quot;comment&quot;: &quot;c9ide User&quot;,
  &quot;ssh_keys&quot;: [
    &quot;&quot;
  ],
  &quot;home&quot;: &quot;/home/c9ide&quot;,
  &quot;ssh_keygen&quot;: false
}
</pre></div>


<p>Next, back to <code>recipe/default.rb</code>, we can invoke the external chef recipe "users" to have this user installed on our system:</p>
<div class="highlight"><pre><span></span>include_recipe &#39;user::data_bag&#39;
</pre></div>


<p>To create an attributes file:</p>
<div class="highlight"><pre><span></span>chef generate attribute default
</pre></div>


<p>and in <code>attributes/default.rb</code> add the line:</p>
<div class="highlight"><pre><span></span>default[&#39;users&#39;] = &#39;c9ide&#39;
</pre></div>


<p>This of course shows the fantastic power and utility of Chef since we can call upon a wide range of libraries already created by the chef community. Now we need to tell Chef that we are using an external library, so in our <code>metadata.rb</code> file at the top level we add the line at the end:</p>
<div class="highlight"><pre><span></span>depends          &#39;user&#39;
</pre></div>


<p>At the same level there is a Berksfile with the content:</p>
<div class="highlight"><pre><span></span>source &#39;https://supermarket.chef.io&#39;

metadata
</pre></div>


<p>which tells chef to check this <code>metadata.rb</code> file for dependencies (such as the user dependency we just added) that we need to pull and make available during cooking. We'll show how this is done manually a bit later, but for now <code>kitchen converge</code> takes care of that.</p>
<p>Now run <code>kitchen converge</code> one more time, and you should see that the user is created. </p>
<p>Let's create a quick smoke test item, add:</p>
<div class="highlight"><pre><span></span>describe user(&#39;c9ide&#39;) do
    it { should exist }
end
</pre></div>


<p>to <code>test/default/default_test.rb</code> and run </p>
<div class="highlight"><pre><span></span>kitchen verify
</pre></div>


<p>if all went well you will see:</p>
<div class="highlight"><pre><span></span> User c9ide
     ✔  should exist
</pre></div>


<p>Now is a good time to push to github:</p>
<div class="highlight"><pre><span></span>git add .
git commit -m &quot;Adds update and users&quot;
git push origin master
</pre></div>


<h6>Installing MOTD</h6>
<p>First, let's generate a blank template file:</p>
<div class="highlight"><pre><span></span>chef generate template motd
</pre></div>


<p>fill with content:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;motd-attributes&#39;</span><span class="o">][</span><span class="s1">&#39;message&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">The hostname of this node is </span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;hostname&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">The IP address of this node is </span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;ipaddress&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>


<p>and create a recipe file <code>recipes/motd.rb</code> with contents:</p>
<div class="highlight"><pre><span></span>template &#39;/etc/motd&#39; do
      source &#39;motd.erb&#39;
      mode &#39;0644&#39;
end
</pre></div>


<p>and finally add this line to the <code>attributes/default.rb</code> file:</p>
<div class="highlight"><pre><span></span>default[&#39;motd-attributes&#39;][&#39;message&#39;] = &quot;A Cloud 9 IDE server&quot;
</pre></div>


<p>We add the following tests at <code>test/smoke/default/motd_test.rb</code>:</p>
<div class="highlight"><pre><span></span>describe directory(&#39;/etc/motd&#39;) do  # describe this directory
    its(:content) { should match /A Cloud 9 IDE server/ }
end
</pre></div>


<p>We run <code>kitchen converge</code> and <code>kitchen verify</code> again to make sure the recipe is fine, and then push to github as before.</p>
<h6>Installing Packages</h6>
<p>We are getting close to installing the Cloud9 IDE. Before doing so, we need to install some packages. Some of these packages are for security purposes, or convenience in administration, while others are needed for the Cloud 9 IDE system.</p>
<p>Create a file <code>recipe/packages.rb</code> with content:</p>
<div class="highlight"><pre><span></span>case node[&#39;platform&#39;]
when &#39;debian&#39;, &#39;ubuntu&#39;

    req_packages = [&#39;fail2ban&#39;,
                    &#39;gcc&#39;,
                    &#39;g++&#39;,
                    &#39;git&#39;,
                    &#39;htop&#39;,
                    &#39;make&#39;,
                    &#39;nodejs&#39;,
                    &#39;nmap&#39;,
                    &#39;npm&#39;,
                    &#39;sysstat&#39;,
                    &#39;unattended-upgrades&#39;,
                    &#39;apt-listchanges&#39;]

    req_packages.each do |packs|
      Chef::Log.info(&quot;Installing: &quot; + packs)
      package packs do
        action :install
      end
    end

    template &#39;/etc/apt/apt.conf.d/50unattended-upgrades&#39; do
        owner &#39;root&#39;
        group &#39;root&#39;
        mode &#39;0644&#39;
        source &#39;50unattended-upgrades.erb&#39;
    end

    template &#39;/etc/apt/apt.conf.d/20auto-upgrades&#39; do
        owner &#39;root&#39;
        group &#39;root&#39;
        mode &#39;0644&#39;
        source &#39;20auto-upgrades.erb&#39;
    end

when &#39;redhat&#39;, &#39;centos&#39;, &#39;fedora&#39;

    req_packages = [&#39;fail2ban&#39;,
                    &#39;gcc-c++&#39;,
                    &#39;git&#39;,
                    &#39;glibc-static&#39;,
                    &#39;htop&#39;,
                    &#39;make&#39;,
                    &#39;nodejs&#39;,
                    &#39;nmap&#39;,
                    &#39;npm&#39;,
                    &#39;sysstat&#39;,
                    &#39;yum-cron&#39;]

    req_packages.each do |packs|
      Chef::Log.info(&quot;Installing: &quot; + packs)
      package packs do
        action :install
      end
    end

    template &#39;/etc/yum/yum-cron.conf&#39; do
        owner &#39;root&#39;
        group &#39;root&#39;
        mode &#39;0644&#39;
        source &#39;yum-cron.conf.erb&#39;
    end

    execute &#39;systemctl enable yum-cron&#39; do
    end

    execute &#39;systemctl start yum-cron&#39; do
    end

end
</pre></div>


<p>Notice that we have sneaked in automated security updates as well. For that, we require the following templates:</p>
<p><code>templates/50unattended-upgrades.erb</code>:</p>
<div class="highlight"><pre><span></span><span class="x">// Automatically upgrade packages from these (origin, archive) pairs</span>
<span class="x">Unattended-Upgrade::Allowed-Origins {</span>
<span class="x">  </span><span class="cp">&lt;%</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;unattended-upgrades&#39;</span><span class="o">][</span><span class="s1">&#39;origins&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">origin</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &quot;</span><span class="cp">&lt;%=</span> <span class="n">origin</span> <span class="cp">%&gt;</span><span class="x">&quot;;</span>
<span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">};</span>

<span class="x">// List of packages to not update</span>
<span class="x">Unattended-Upgrade::Package-Blacklist {</span>
<span class="x">  &quot;apache2&quot;;</span>
<span class="x">  &quot;nginx&quot;;</span>
<span class="x">//  &quot;libc6-dev&quot;;</span>
<span class="x">//  &quot;libc6-i686&quot;;</span>
<span class="x">};</span>

<span class="x">// Send email to this address for problems or packages upgrades</span>
<span class="x">// If empty or unset then no email is sent, make sure that you</span>
<span class="x">// have a working mail setup on your system. The package &#39;mailx&#39;</span>
<span class="x">// must be installed or anything that provides /usr/bin/mail.</span>
<span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;unattended-upgrades&#39;</span><span class="o">][</span><span class="s1">&#39;send_email&#39;</span><span class="o">]</span> <span class="p">?</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span> <span class="s2">&quot;// &quot;</span> <span class="cp">%&gt;</span><span class="x">Unattended-Upgrade::Mail &quot;</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;unattended-upgrades&#39;</span><span class="o">][</span><span class="s1">&#39;email_address&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">&quot;;</span>

<span class="x">// Do automatic removal of new unused dependencies after the upgrade</span>
<span class="x">// (equivalent to apt-get autoremove)</span>
<span class="x">Unattended-Upgrade::Remove-Unused-Dependencies &quot;</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;unattended-upgrades&#39;</span><span class="o">][</span><span class="s1">&#39;auto_remove&#39;</span><span class="o">]</span> <span class="p">?</span> <span class="s2">&quot;true&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span> <span class="cp">%&gt;</span><span class="x">&quot;;</span>

<span class="x">// Automatically reboot *WITHOUT CONFIRMATION* if a</span>
<span class="x">// the file /var/run/reboot-required is found after the upgrade</span>
<span class="x">Unattended-Upgrade::Automatic-Reboot &quot;</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;unattended-upgrades&#39;</span><span class="o">][</span><span class="s1">&#39;auto_reboot&#39;</span><span class="o">]</span> <span class="p">?</span> <span class="s2">&quot;true&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span> <span class="cp">%&gt;</span><span class="x">&quot;;</span>
</pre></div>


<p><code>templates/20auto-upgrades.erb</code>:</p>
<div class="highlight"><pre><span></span><span class="x">APT::Periodic::Update-Package-Lists &quot;</span><span class="cp">&lt;%=</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;unattended-upgrades&#39;</span><span class="o">][</span><span class="s1">&#39;update_package_lists_interval&#39;</span><span class="o">]</span><span class="cp">%&gt;</span><span class="x">&quot;;</span>
<span class="x">APT::Periodic::Unattended-Upgrade &quot;</span><span class="cp">&lt;%=</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;unattended-upgrades&#39;</span><span class="o">][</span><span class="s1">&#39;upgrade_interval&#39;</span><span class="o">]</span><span class="cp">%&gt;</span><span class="x">&quot;;</span>
</pre></div>


<p>and</p>
<p><code>templates/yum-cron.conf.erb</code>:</p>
<div class="highlight"><pre><span></span>update_cmd = security
apply_updates = yes
</pre></div>


<div class="highlight"><pre><span></span>default[&#39;unattended-upgrades&#39;][&#39;update_package_lists_interval&#39;] = &quot;1&quot;
default[&#39;unattended-upgrades&#39;][&#39;upgrade_interval&#39;] = &quot;1&quot;
default[&#39;unattended-upgrades&#39;][&#39;origins&#39;] = [&#39;<span class="cp">${</span><span class="n">distro_id</span><span class="cp">}</span> <span class="cp">${</span><span class="n">distro_codename</span><span class="cp">}</span>-security&#39;]
default[&#39;unattended-upgrades&#39;][&#39;send_email&#39;] = false
default[&#39;unattended-upgrades&#39;][&#39;email_address&#39;] = &quot;test@example.com&quot;
default[&#39;unattended-upgrades&#39;][&#39;auto_remove&#39;] = false
default[&#39;unattended-upgrades&#39;][&#39;auto_reboot&#39;] = false
</pre></div>


<p>and of course, our inspec test in <code>test/smoke/default/packages_test.rb</code>:</p>
<div class="highlight"><pre><span></span>if os[:family] == &#39;debian&#39;
    req_packages = [&#39;fail2ban&#39;,
                    &#39;gcc&#39;,
                    &#39;g++&#39;,
                    &#39;git&#39;,
                    &#39;htop&#39;,
                    &#39;make&#39;,
                    &#39;nodejs&#39;,
                    &#39;nmap&#39;,
                    &#39;npm&#39;,
                    &#39;sysstat&#39;,
                    &#39;unattended-upgrades&#39;,
                    &#39;apt-listchanges&#39;]

    req_packages.each do |packs|
      describe package(packs) do
        it { should be_installed }
      end
    end

else

    req_packages = [&#39;fail2ban&#39;,
                    &#39;gcc-c++&#39;,
                    &#39;git&#39;,
                    &#39;glibc-static&#39;,
                    &#39;htop&#39;,
                    &#39;make&#39;,
                    &#39;nodejs&#39;,
                    &#39;nmap&#39;,
                    &#39;npm&#39;,
                    &#39;sysstat&#39;,
                    &#39;yum-cron&#39;]

    req_packages.each do |packs|
      describe package(packs) do
        it { should be_installed }
      end
    end
end
</pre></div>


<h6>Installing Cloud 9 IDE</h6>
<p>Chef has a built-in git resource that we can use to pull the Cloud 9 IDE code.</p>
<p>The test for this section will be rather brief:</p>
<div class="highlight"><pre><span></span>describe directory(&#39;/home/c9ide/core/README.md&#39;) do  # describe this directory
    its(:content) { should match /^Cloud9/ }
end
</pre></div>


<p>and the reason is that we can really verify whether or not this section succeeded in the next section on running via supervisor.</p>
<p>The code for this section, in <code>/recipes/c9ide.rb</code>, is:</p>
<div class="highlight"><pre><span></span>git &quot;/home/c9ide/core&quot; do
   repository &#39;https://github.com/c9/core.git&#39;
   reference &#39;master&#39;
   action :sync
end

case node[&#39;platform&#39;]
when &#39;debian&#39;, &#39;ubuntu&#39;
    bash &#39;create nodejs link&#39; do
        code &lt;&lt;-EOH
        ln -s /usr/bin/nodejs /usr/bin/node
        EOH
        not_if { ::File.exist?(&#39;/usr/bin/node&#39;) }
    end
end

bash &#39;install_cloud9ide&#39; do
   cwd &#39;/home/c9ide/core/&#39;
   user &#39;root&#39;
   code &lt;&lt;-EOH
     scripts/install-sdk.sh
     EOH
   environment &#39;PREFIX&#39; =&gt; &#39;/usr/local&#39;
end
</pre></div>


<h6>Installing Supervisor</h6>
<p>Finally, we want to leave our server running Cloud 9 IDE after provisioning it. Supervisor is a fantastic way to do so, though of course not the only way and perhaps not even the best way, but it is a convenient and production-ready solution (though this development kit version of Cloud 9 IDE is not production material and is meant for development purposes).</p>
<p>In <code>recipes/supervisor.rb</code>:</p>
<div class="highlight"><pre><span></span>package &#39;supervisor&#39; do
    action :install
end

case node[&#39;platform&#39;]
when &#39;debian&#39;, &#39;ubuntu&#39;

    cookbook_file &#39;/etc/supervisor/conf.d/cloud9ide.conf&#39; do
      source &#39;c9ide.conf&#39;
      owner &#39;root&#39;
      group &#39;root&#39;
      mode &#39;0755&#39;
      action :create
    end

    execute &#39;start supervisor&#39; do
      command &#39;service supervisor start&#39;
    end

    execute &#39;reload supervisor&#39; do
      command &#39;supervisorctl update&#39;
    end

when &#39;redhat&#39;, &#39;centos&#39;, &#39;fedora&#39;

    cookbook_file &#39;/etc/supervisord.d/cloud9ide.ini&#39; do
      source &#39;c9ide.conf&#39;
      owner &#39;root&#39;
      group &#39;root&#39;
      mode &#39;0755&#39;
      action :create
    end

    execute &#39;start supervisor&#39; do
      command &#39;service supervisord start&#39;
    end

    execute &#39;reload supervisor&#39; do
      command &#39;supervisorctl update&#39;
    end
end
</pre></div>


<p>and finally add this to the <code>c9ide_test.rb</code> test file:</p>
<div class="highlight"><pre><span></span>describe port(9999) do
  it { should be_listening }
end
</pre></div>


<h5>Putting it all together</h5>
<p>The default recipe should now look like this:</p>
<div class="highlight"><pre><span></span>include_recipe &#39;c9_ide::update&#39;
include_recipe &#39;user::data_bag&#39;
include_recipe &#39;c9_ide::motd&#39;
include_recipe &#39;c9_ide::packages&#39;
include_recipe &#39;c9_ide::cloud9ide&#39;
include_recipe &#39;c9_ide::supervisor&#39;
</pre></div>


<p>we run a final <code>kitchen converge</code>; if all goes well, we follow up with a final <code>kitchen verify</code>:</p>
<div class="highlight"><pre><span></span><span class="o">-----&gt;</span> <span class="n">Starting</span> <span class="n">Kitchen</span> <span class="p">(</span><span class="n">v1</span><span class="mf">.14.2</span><span class="p">)</span>
<span class="o">-----&gt;</span> <span class="n">Setting</span> <span class="n">up</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">&gt;</span><span class="p">...</span>
       <span class="n">Finished</span> <span class="n">setting</span> <span class="n">up</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="n">m0</span><span class="mf">.00</span><span class="n">s</span><span class="p">).</span>
<span class="o">-----&gt;</span> <span class="n">Verifying</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">&gt;</span><span class="p">...</span>
       <span class="n">Loaded</span>

<span class="nl">Target</span><span class="p">:</span>  <span class="nl">ssh</span><span class="p">:</span><span class="c1">//vagrant@127.0.0.1:2222</span>


  <span class="n">File</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">c9ide</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">README</span><span class="p">.</span><span class="n">md</span>
     <span class="err">✔</span>  <span class="n">content</span> <span class="n">should</span> <span class="n">match</span> <span class="o">/^</span><span class="n">Cloud9</span><span class="o">/</span>
  <span class="n">Port</span> <span class="mi">9999</span>
     <span class="err">✔</span>  <span class="n">should</span> <span class="n">be</span> <span class="n">listening</span>
  <span class="n">User</span> <span class="n">c9ide</span>
     <span class="err">✔</span>  <span class="n">should</span> <span class="n">exist</span>
  <span class="n">File</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">motd</span>
     <span class="err">✔</span>  <span class="n">content</span> <span class="n">should</span> <span class="n">match</span> <span class="o">/</span><span class="n">A</span> <span class="n">Cloud</span> <span class="mi">9</span> <span class="n">IDE</span> <span class="n">server</span><span class="o">/</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">fail2ban</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">gcc</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">g</span><span class="o">++</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">git</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">htop</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">make</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">nodejs</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">nmap</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">npm</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">sysstat</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">unattended</span><span class="o">-</span><span class="n">upgrades</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">apt</span><span class="o">-</span><span class="n">listchanges</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>

<span class="n">Test</span> <span class="nl">Summary</span><span class="p">:</span> <span class="mi">16</span> <span class="n">successful</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skipped</span>
       <span class="n">Finished</span> <span class="n">verifying</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="mi">1604</span><span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="n">m1</span><span class="mf">.28</span><span class="n">s</span><span class="p">).</span>
<span class="o">-----&gt;</span> <span class="n">Setting</span> <span class="n">up</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">centos</span><span class="o">-</span><span class="mi">72</span><span class="o">&gt;</span><span class="p">...</span>
       <span class="n">Finished</span> <span class="n">setting</span> <span class="n">up</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">centos</span><span class="o">-</span><span class="mi">72</span><span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="n">m0</span><span class="mf">.00</span><span class="n">s</span><span class="p">).</span>
<span class="o">-----&gt;</span> <span class="n">Verifying</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">centos</span><span class="o">-</span><span class="mi">72</span><span class="o">&gt;</span><span class="p">...</span>
       <span class="n">Loaded</span>

<span class="nl">Target</span><span class="p">:</span>  <span class="nl">ssh</span><span class="p">:</span><span class="c1">//vagrant@127.0.0.1:2200</span>


  <span class="n">File</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">c9ide</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">README</span><span class="p">.</span><span class="n">md</span>
     <span class="err">✔</span>  <span class="n">content</span> <span class="n">should</span> <span class="n">match</span> <span class="o">/^</span><span class="n">Cloud9</span><span class="o">/</span>
  <span class="n">Port</span> <span class="mi">9999</span>
     <span class="err">✔</span>  <span class="n">should</span> <span class="n">be</span> <span class="n">listening</span>
  <span class="n">User</span> <span class="n">c9ide</span>
     <span class="err">✔</span>  <span class="n">should</span> <span class="n">exist</span>
  <span class="n">File</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">motd</span>
     <span class="err">✔</span>  <span class="n">content</span> <span class="n">should</span> <span class="n">match</span> <span class="o">/</span><span class="n">A</span> <span class="n">Cloud</span> <span class="mi">9</span> <span class="n">IDE</span> <span class="n">server</span><span class="o">/</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">fail2ban</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">gcc</span><span class="o">-</span><span class="n">c</span><span class="o">++</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">git</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">glibc</span><span class="o">-</span><span class="k">static</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">htop</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">make</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">nodejs</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">nmap</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">npm</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">sysstat</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>
  <span class="n">System</span> <span class="n">Package</span>
     <span class="err">✔</span>  <span class="n">yum</span><span class="o">-</span><span class="n">cron</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span>

<span class="n">Test</span> <span class="nl">Summary</span><span class="p">:</span> <span class="mi">15</span> <span class="n">successful</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">skipped</span>
       <span class="n">Finished</span> <span class="n">verifying</span> <span class="o">&lt;</span><span class="k">default</span><span class="o">-</span><span class="n">centos</span><span class="o">-</span><span class="mi">72</span><span class="o">&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="n">m13</span><span class="mf">.80</span><span class="n">s</span><span class="p">).</span>
<span class="o">-----&gt;</span> <span class="n">Kitchen</span> <span class="n">is</span> <span class="n">finished</span><span class="p">.</span> <span class="p">(</span><span class="mi">0</span><span class="n">m16</span><span class="mf">.47</span><span class="n">s</span><span class="p">)</span>
</pre></div>


<p>Congratulations, you have a basic working chef recipe for installing Cloud 9 IDE, tested and provisioned on both major families of Linux.</p>
<h3>Source Code</h3>
<p>You can find the source code for this recipe on my github account <a href="https://github.com/doctimjones/c9_ide_chef/tree/PartI">here</a>.</p>
<h3>Future Steps</h3>
<p>We took some shortcuts and avoided some best practices for convenience here. Ideally we would like some unit tests and to pull in more community recipes. For example, the supervisor chef cookbook could be used here instead of dealing with that in a platform case. </p>
<p>In the forthcoming Part II, we will use Puppet, a widely used alternative to Chef, to provision a server that runs the Cloud 9 IDE SDK as we have here with Chef.</p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        Tim Jones
    </span>
  </span>
<time datetime="2017-01-28T17:00:00-05:00" pubdate>Sat 28 January 2017</time>  <span class="categories">
    <a class='category' href='http://doctimjones.org/category/devops.html'>DevOps</a>
  </span>
  <span class="categories">
    <a class="category" href="http://doctimjones.org/tag/aws.html">AWS</a>,    <a class="category" href="http://doctimjones.org/tag/chef.html">Chef</a>,    <a class="category" href="http://doctimjones.org/tag/cloudformation.html">Cloudformation</a>  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://doctimjones.org/using-docker-sparker-to-get-a-quick-out-of-the-box-cloud9-idejupytersparkpandasetc-experience.html">Using Docker-Sparker to get a quick out-of-the-box Cloud9 IDE/Jupyter/Spark/Pandas/etc. experience</a>
      </li>
      <li class="post">
          <a href="http://doctimjones.org/bize-sized-stochastic-control-theory.html">Bize sized stochastic control theory</a>
      </li>
      <li class="post">
          <a href="http://doctimjones.org/aws-virtual-machines-cook-thyself-part-i.html">AWS Virtual Machines, cook thyself! Part I</a>
      </li>
      <li class="post">
          <a href="http://doctimjones.org/python-uses-operational-chaining-for-boolean-comparisons.html">Python uses operational chaining for boolean comparisons</a>
      </li>
      <li class="post">
          <a href="http://doctimjones.org/integrating-the-rossler-system-with-ipython-notebooks.html">Integrating the Rossler System with iPython Notebooks</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://doctimjones.org/category/computer-science.html">Computer Science</a></li>
        <li><a href="http://doctimjones.org/category/data-science.html">Data Science</a></li>
        <li><a href="http://doctimjones.org/category/devops.html">DevOps</a></li>
        <li><a href="http://doctimjones.org/category/math.html">Math</a></li>
        <li><a href="http://doctimjones.org/category/mathematics-systems.html">Mathematics, Systems</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://doctimjones.org/tag/devops.html">DevOps</a>,    <a href="http://doctimjones.org/tag/python.html">Python</a>,    <a href="http://doctimjones.org/tag/data-science.html">Data Science</a>,    <a href="http://doctimjones.org/tag/docker.html">Docker</a>,    <a href="http://doctimjones.org/tag/spark.html">Spark</a>,    <a href="http://doctimjones.org/tag/cloud-9-ide.html">Cloud 9 IDE</a>,    <a href="http://doctimjones.org/tag/jupyter.html">Jupyter</a>,    <a href="http://doctimjones.org/tag/pandas.html">Pandas</a>,    <a href="http://doctimjones.org/tag/google-compute.html">Google Compute</a>,    <a href="http://doctimjones.org/tag/ssh.html">SSH</a>,    <a href="http://doctimjones.org/tag/control-theory.html">Control Theory</a>,    <a href="http://doctimjones.org/tag/stochastic.html">Stochastic</a>,    <a href="http://doctimjones.org/tag/aws.html">AWS</a>,    <a href="http://doctimjones.org/tag/chef.html">Chef</a>,    <a href="http://doctimjones.org/tag/cloudformation.html">Cloudformation</a>,    <a href="http://doctimjones.org/tag/math.html">Math</a>,    <a href="http://doctimjones.org/tag/physics.html">Physics</a>,    <a href="http://doctimjones.org/tag/thesis.html">Thesis</a>,    <a href="http://doctimjones.org/tag/linux.html">Linux</a>,    <a href="http://doctimjones.org/tag/networking.html">Networking</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="https://twitter.com/doctimjones" target="_blank">Twitter</a></li>
            <li><a href="https://www.linkedin.com/in/timothy-jones-3a60814b" target="_blank">Linked In</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2016&ndash;2017  Tim Jones &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="http://doctimjones.org/theme/js/modernizr-2.0.js"></script>
  <script src="http://doctimjones.org/theme/js/ender.js"></script>
  <script src="http://doctimjones.org/theme/js/octopress.js" type="text/javascript"></script>
</body>
</html>